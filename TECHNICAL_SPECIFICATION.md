# Техническое задание: Text-to-Audio конвертер

## 1. Общее описание проекта

### 1.1 Назначение
Разработать приложение для конвертации текстовых документов в аудиофайлы с использованием технологии синтеза речи Yandex SpeechKit.

### 1.2 Цель проекта
Создать CLI-приложение, которое принимает на вход текстовый документ и возвращает аудиофайл с озвученным текстом.


## 2. Функциональные требования

### 2.1 Основная функциональность
- Чтение текстовых документов различных форматов
- Синтез речи из текста с использованием Yandex SpeechKit
- Сохранение результата в виде аудиофайла
- CLI интерфейс для взаимодействия с пользователем

### 2.2 Поддерживаемые форматы входных файлов
- `.txt` - обычные текстовые файлы
- `.docx` - документы Microsoft Word
- `.pdf` - документы в формате PDF
- `.md` - файлы разметки Markdown

### 2.3 Поддерживаемые форматы выходных файлов
- `WAV` - несжатый аудиоформат
- `MP3` - сжатый аудиоформат
- `OGG` - открытый аудиоформат

### 2.4 Параметры синтеза речи
- **Язык**: Русский (по умолчанию, без возможности изменения)
- **Голос**: Стандартный голос Yandex SpeechKit (без возможности выбора)
- **Качество**: Высокое качество синтеза

## 3. Технические требования

### 3.1 Платформа и технологии
- **Язык программирования**: Python 3.9+
- **Внешний сервис**: Yandex Cloud SpeechKit API v3
- **Развертывание**: Docker контейнер
- **Интерфейс**: Command Line Interface (CLI)

### 3.2 Аутентификация
- Использование сервисного аккаунта Yandex Cloud
- Авторизованный ключ в формате JSON для создания JWT токенов
- Обмен JWT токена на IAM токен для доступа к API
- Кэширование IAM токенов (срок жизни до 12 часов)

### 3.3 Ограничения Yandex SpeechKit API

#### 3.3.1 Лимиты на запросы
- **API v3 (unsafe режим)**: максимум 5,000 символов на запрос
- **Квота**: 40 запросов в секунду

#### 3.3.2 Технические ограничения
- Максимальная длительность синтеза: 24 секунды на запрос (API v3)
- Необходимость разбивки длинных текстов на части

### 3.4 Обработка больших файлов
- Автоматическая разбивка текста на части не более 4,500 символов
- Умная разбивка с сохранением целостности предложений и абзацев
- Последовательный синтез каждой части
- Автоматическое объединение полученных аудиофрагментов в единый файл

## 4. Нефункциональные требования

### 4.1 Надежность и обработка ошибок
- **Retry логика**: Автоматические повторные попытки при временных сбоях
- **Graceful degradation**: Возврат частичного результата при критических ошибках
- **Сохранение прогресса**: Возможность продолжения обработки с места остановки
- **Обработка rate limiting**: Соблюдение ограничений API на количество запросов

### 4.2 Логирование и мониторинг
- Детальное логирование всех операций
- Отображение прогресса обработки для длинных документов
- Статистика обработки (время, количество символов, количество запросов)
- Уведомления об ошибках с описанием проблемы

### 4.3 Производительность
- Эффективное использование API квот
- Минимизация времени обработки
- Оптимальное использование памяти при работе с большими файлами

### 4.4 Удобство использования
- Простой и понятный CLI интерфейс
- Информативные сообщения об ошибках
- Справочная информация по использованию
- Валидация входных параметров


## 5. Интерфейс командной строки

### 5.1 Основная команда
```bash
python main.py --input <входной_файл> --output <выходной_файл> --format <формат>
```

### 5.2 Параметры
- `--input, -i`: Путь к входному текстовому файлу (обязательный)
- `--output, -o`: Путь к выходному аудиофайлу (обязательный)
- `--format, -f`: Формат выходного файла (wav/mp3/ogg, по умолчанию wav)
- `--help, -h`: Справочная информация


## 6. Архитектурные требования

### 6.1 Модульность
- Разделение функциональности на независимые модули
- Четкое разграничение ответственности между компонентами
- Возможность тестирования отдельных модулей

### 6.2 Расширяемость
- Возможность добавления новых форматов входных файлов
- Возможность добавления новых форматов выходных файлов
- Гибкая настройка параметров синтеза

### 6.3 Контейнеризация
- Полная изоляция приложения в Docker контейнере
- Включение всех необходимых зависимостей
- Простота развертывания и запуска

## 7. Безопасность

### 7.1 Управление ключами
- Безопасное хранение авторизованного ключа
- Защита от утечки конфиденциальной информации в логах
- Валидация и проверка целостности ключей

### 7.2 Обработка данных
- Безопасная обработка пользовательских файлов
- Очистка временных файлов после обработки
- Защита от потенциальных уязвимостей при парсинге файлов

## 8. Ограничения и допущения

### 8.1 Ограничения
- Поддержка только русского языка
- Зависимость от доступности Yandex Cloud API
- Ограничения по размеру файлов (определяются доступными ресурсами)

### 8.2 Допущения
- Наличие стабильного интернет-соединения
- Корректность и читаемость входных текстовых файлов
- Достаточность квот Yandex Cloud для обработки

## 11. План реализации

### 11.1 Структура проекта
```
text-to-audio/
├── src/                           # Исходный код приложения
│   ├── __init__.py
│   ├── main.py                    # CLI интерфейс и точка входа
│   ├── auth.py                    # Аутентификация (JWT/IAM токены)
│   ├── synthesizer.py             # Синтез речи через SpeechKit API v3
│   ├── text_processor.py          # Обработка и разбивка текста
│   ├── file_handlers.py           # Чтение файлов (txt/docx/pdf/md)
│   ├── audio_merger.py            # Объединение аудиофрагментов
│   └── utils.py                   # Логирование и вспомогательные функции
├── secrets/                       # Секреты (НЕ в Git!)
│   └── authorized_key.json        # Ключ Yandex Cloud
├── input/                         # Входные файлы для обработки
├── output/                        # Выходные аудиофайлы
├── requirements.txt               # Python зависимости
├── Dockerfile                     # Docker конфигурация
├── docker-compose.yml             # Development конфигурация
├── docker-compose.prod.yml        # Production конфигурация
├── .env.example                   # Пример переменных окружения
├── .gitignore                     # Исключения для Git
├── README.md                      # Документация пользователя
└── TECHNICAL_SPECIFICATION.md     # Техническое задание
```

### 11.2 Модули приложения

#### 11.2.1 Модуль аутентификации (`auth.py`)
**Ключевые функции:**
- `load_yandex_key()` - загрузка ключа из Docker Secret
- `create_jwt_token()` - создание JWT токена с PyJWT
- `get_iam_token()` - обмен JWT на IAM токен
- `TokenManager` - класс для кэширования и автообновления токенов
- `validate_key_format()` - валидация структуры ключа

**Технические особенности:**
- Чтение ключа из `/run/secrets/yandex_authorized_key`
- Кэширование IAM токена в Redis (опционально)
- Автоматическое обновление токена за 10 минут до истечения
- Retry логика для сетевых запросов

#### 11.2.2 Модуль чтения файлов (`file_handlers.py`)
**Поддерживаемые форматы:**
- `.txt` - `TextFileHandler` с автоопределением кодировки
- `.md` - `MarkdownFileHandler` с базовой обработкой разметки
- `.docx` - `DocxFileHandler` с использованием `python-docx`
- `.pdf` - `PdfFileHandler` с использованием `PyPDF2` и `pdfplumber`

**Функциональность:**
- `FileHandlerFactory` - фабрика для создания обработчиков
- `extract_text()` - универсальный метод извлечения текста
- Обработка ошибок кодировки и поврежденных файлов
- Валидация размера и типа файлов

#### 11.2.3 Модуль обработки текста (`text_processor.py`)
**Основные функции:**
- `TextSplitter` - класс для умной разбивки текста
- `split_by_sentences()` - разбивка по предложениям
- `split_by_paragraphs()` - разбивка по абзацам
- `optimize_chunks()` - оптимизация размера фрагментов

**Алгоритм разбивки:**
- Максимум 4,500 символов на фрагмент (запас от лимита 5,000)
- Приоритет: предложения → абзацы → принудительная разбивка
- Сохранение контекста и нумерации фрагментов
- Обработка специальных символов и разметки

#### 11.2.4 Модуль синтеза речи (`synthesizer.py`)
**Ключевые компоненты:**
- `SpeechSynthesizer` - основной класс синтеза
- `configure_speechkit()` - настройка SDK с unsafe режимом
- `synthesize_chunk()` - синтез одного фрагмента
- `batch_synthesize()` - пакетная обработка фрагментов

**Настройки API v3 unsafe:**
- Голос: `jane` (русский женский голос)
- Роль: `good` (нейтральная интонация)
- Формат: WAV 16kHz (высокое качество)
- Rate limiting: максимум 40 запросов/сек
- Retry: 3 попытки с экспоненциальным backoff

#### 11.2.5 Модуль объединения аудио (`audio_merger.py`)
**Функциональность:**
- `AudioMerger` - класс для работы с аудио
- `merge_wav_files()` - объединение WAV файлов
- `convert_format()` - конвертация в MP3/OGG
- `cleanup_temp_files()` - очистка временных файлов

#### 11.2.6 CLI интерфейс (`main.py`)
**Структура команд:**
```bash
python main.py [OPTIONS]

Options:
  -i, --input PATH     Входной файл (txt/docx/pdf/md) [обязательный]
  -o, --output PATH    Выходной аудиофайл [обязательный]
  -f, --format TEXT    Формат аудио (wav/mp3/ogg) [по умолчанию: wav]
  --temp-dir PATH      Папка для временных файлов
  --log-level TEXT     Уровень логирования (DEBUG/INFO/WARNING/ERROR)
  --help               Справочная информация
```

#### 11.2.7 Система логирования (`utils.py`)
**Компоненты:**
- `setup_logging()` - настройка логгера
- `ProgressTracker` - отслеживание прогресса
- `StatisticsCollector` - сбор статистики
- `safe_log()` - безопасное логирование без секретов

### 11.3 Docker конфигурация

#### 11.3.1 Безопасность с Docker Secrets
**Структура секретов:**
- Ключ хранится в `./secrets/authorized_key.json`
- Монтируется в контейнер как `/run/secrets/yandex_authorized_key`
- Исключен из Git через `.gitignore`

#### 11.3.2 Docker Compose конфигурация
```yaml
version: '3.8'

services:
  text-to-audio:
    build: .
    volumes:
      - ./input:/app/input:ro
      - ./output:/app/output
      - temp_data:/app/temp
    secrets:
      - yandex_authorized_key
    environment:
      - YANDEX_KEY_PATH=/run/secrets/yandex_authorized_key
      - LOG_LEVEL=INFO
    depends_on:
      - redis

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data

secrets:
  yandex_authorized_key:
    file: ./secrets/authorized_key.json

volumes:
  temp_data:
  redis_data:
```

### 11.4 Зависимости
```
# Основные зависимости
yandex-speechkit>=2.0.0
PyJWT>=2.8.0
cryptography>=41.0.0

# Обработка файлов
python-docx>=0.8.11
PyPDF2>=3.0.0
pdfplumber>=0.9.0

# Аудио обработка
pydub>=0.25.1

# CLI и утилиты
click>=8.1.0
tqdm>=4.65.0
colorama>=0.4.6

# Сеть и кэширование
requests>=2.31.0
redis>=4.5.0

# Логирование
structlog>=23.1.0
```

### 11.5 Алгоритм работы приложения

#### Этапы обработки:
1. **Инициализация** (5%)
   - Валидация параметров CLI
   - Настройка логирования
   - Проверка доступности файлов

2. **Аутентификация** (10%)
   - Загрузка ключа из Docker Secret
   - Создание JWT токена
   - Получение IAM токена

3. **Чтение файла** (15%)
   - Определение типа файла
   - Извлечение текста
   - Валидация содержимого

4. **Обработка текста** (20%)
   - Разбивка на фрагменты ≤4,500 символов
   - Оптимизация границ разбивки
   - Создание очереди задач

5. **Синтез речи** (40%)
   - Последовательная обработка фрагментов
   - Retry при ошибках
   - Сохранение промежуточных результатов

6. **Объединение аудио** (8%)
   - Склейка фрагментов
   - Конвертация в целевой формат
   - Валидация результата

7. **Завершение** (2%)
   - Очистка временных файлов
   - Вывод статистики
   - Логирование результата

### 11.6 Команды для развертывания

#### Подготовка:
```bash
# Создание структуры
mkdir -p secrets input output
cp authorized_key.json secrets/
cp .env.example .env

# Настройка прав
chmod 600 secrets/authorized_key.json
```

#### Запуск:
```bash
# Development
docker-compose up --build

# Production
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

# Использование
docker-compose exec text-to-audio python src/main.py \
  -i /app/input/document.pdf \
  -o /app/output/audiobook.mp3 \
  -f mp3
```

### 11.7 Этапы реализации

1. **Этап 1**: Создание базовой структуры проекта и Docker конфигурации
2. **Этап 2**: Реализация модуля аутентификации
3. **Этап 3**: Реализация модулей чтения файлов
4. **Этап 4**: Реализация модуля обработки текста
5. **Этап 5**: Реализация модуля синтеза речи
6. **Этап 6**: Реализация модуля объединения аудио
7. **Этап 7**: Реализация CLI интерфейса
8. **Этап 8**: Интеграционное тестирование
9. **Этап 9**: Создание документации
10. **Этап 10**: Финальное тестирование и оптимизация

---

**Версия документа**: 1.1  
**Дата создания**: 22.08.2025  
**Дата обновления**: 22.08.2025  
**Статус**: Утверждено к разработке
